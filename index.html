<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hamster Combat Clone</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: url('LeadtexFon.png') no-repeat center center fixed;
    background-size: cover;
    color: white;
  }
  .container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
  }
  .hamster {
    width: 300px;
    height: 300px;
    background: url('LeadtexCoin.png') no-repeat center center;
    background-size: contain;
    cursor: pointer;
    margin: 20px auto;
    transition: transform 0.1s, box-shadow 0.1s;
    user-select: none;
    outline: none;
    -webkit-tap-highlight-color: transparent;
    border-radius: 50%;
  }
  .hamster.active {
    transform: scale(0.95);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }
  #balance, #level {
    position: relative;
    margin: 10px 0;
    font-size: 24px;
    z-index: 10;
    color: white;
  }
  #user-info {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 18px;
    color: white;
  }
  .click-animation {
    position: absolute;
    font-size: 36px;
    color: white;
    animation: fadeUp 1s ease-out forwards;
    pointer-events: none;
  }
  @keyframes fadeUp {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(-50px);
    }
  }
  .shop {
    display: none; /* Убираем старый магазин */
  }
  .progress-bar {
    width: 80%;
    height: 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    margin: 10px auto;
    overflow: hidden;
  }
  .progress-bar-inner {
    height: 100%;
    background: #4caf50;
    width: 0;
    transition: width 0.3s;
  }
  .menu {
    display: flex;
    justify-content: space-around;
    background-color: #2C2F36;
    padding: 10px;
  }
  .menu button {
    background-color: #2C2F36;
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
  }
  .menu button:hover {
    background-color: #3a3d44;
  }
</style>
</head>
<body>
<div id="user-info">ID: <span id="userId"></span><br>Username: <span id="username"></span></div>
<div class="menu">
  <button onclick="showCoin()">Coin</button>
  <button onclick="showUp()">Up</button>
  <button onclick="showTask()">Task</button>
  <button onclick="showTop()">Top</button>
</div>
<div class="container">
  <div id="balance">Баллы: 0</div>
  <div id="level">Уровень: 1</div>
  <div class="progress-bar">
    <div class="progress-bar-inner" id="progress"></div>
  </div>
  <div class="hamster" id="hamster"></div>
</div>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
let balance = 0;
let level = 1;
let pointsToNextLevel = 1000;
let hamsterImage = 'LeadtexCoin.png';
let telegramId = null;

function vibrateOnClick() {
  if ("vibrate" in navigator) {
    window.navigator.vibrate(100); // Короткая вибрация на 100 миллисекунд
  }
}

function incrementScore(event) {
  balance++;
  document.getElementById('balance').textContent = 'Баллы: ' + balance;
  showClickAnimation(event.clientX, event.clientY);
  checkLevelUp();
  updateProgressBar();
  saveGameState();
}

function showClickAnimation(x, y) {
  const clickText = document.createElement('div');
  clickText.textContent = '+1';
  clickText.className = 'click-animation';
  clickText.style.left = `${x}px`;
  clickText.style.top = `${y}px`;
  document.body.appendChild(clickText);
  setTimeout(() => {
    clickText.remove();
  }, 1000);
}

function checkLevelUp() {
  if (balance >= pointsToNextLevel) {
    level++;
    pointsToNextLevel = Math.floor(pointsToNextLevel * 1.5);
    document.getElementById('level').textContent = 'Уровень: ' + level;
  }
}

function updateProgressBar() {
  const progress = Math.min((balance / pointsToNextLevel) * 100, 100);
  document.getElementById('progress').style.width = progress + '%';
}

function showCoin() {
  alert('Coin button clicked');
}

function showUp() {
  alert('Up button clicked');
}

function showTask() {
  alert('Task button clicked');
}

function showTop() {
  alert('Top button clicked');
}

function saveGameState() {
  const gameState = {
    balance: balance,
    level: level,
    pointsToNextLevel: pointsToNextLevel,
    hamsterImage: hamsterImage
  };
  localStorage.setItem('gameState', JSON.stringify(gameState));
}

function loadGameState() {
  const gameState = JSON.parse(localStorage.getItem('gameState'));
  if (gameState) {
    balance = gameState.balance;
    level = gameState.level;
    pointsToNextLevel = gameState.pointsToNextLevel;
    hamsterImage = gameState.hamsterImage;
    document.getElementById('balance').textContent = 'Баллы: ' + balance;
    document.getElementById('level').textContent = 'Уровень: ' + level;
    document.getElementById('hamster').style.backgroundImage = `url(${hamsterImage})`;
    updateProgressBar();
  }
}

function fetchInitialBalance(telegramId) {
  const webhookUrl = 'https://hook.eu2.make.com/3cn7hflf2x478ihdcm38gjgw2rbu5ioa';

  fetch(webhookUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      telegram_id: telegramId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data && data.data && data.data[0] && data.data[0].balance !== undefined) {
      const initialBalance = data.data[0].balance;
      setInitialBalance(initialBalance);
    } else {
      alert('Ошибка получения данных: ' + JSON.stringify(data));
    }
  })
  .catch(error => {
    alert('Ошибка: ' + error);
  });
}

function setInitialBalance(initialBalance) {
  balance = initialBalance;
  document.getElementById('balance').textContent = 'Баллы: ' + balance;
  updateProgressBar();
}

if (window.Telegram && window.Telegram.WebApp) {
  Telegram.WebApp.expand();
  Telegram.WebApp.enableClosingConfirmation();
  const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
  if (initDataUnsafe && initDataUnsafe.user) {
    telegramId = initDataUnsafe.user.id;
    document.getElementById('userId').textContent = telegramId;
    document.getElementById('username').textContent = initDataUnsafe.user.username;
    fetchInitialBalance(telegramId);
    window.Telegram.WebApp.MainButton.setParams({
      text: "Закрыть",
      color: "rgb(77, 76, 76)",
      text_color: "#FFFFFF"
    });
    window.Telegram.WebApp.MainButton.show();
    window.Telegram.WebApp.MainButton.onClick(function() {
      const url = `https://app.leadteh.ru/w/bQ300?utm_campaign=${balance}`;
      window.Telegram.WebApp.openLink(url);
      window.Telegram.WebApp.close();
    });
  } else {
    alert("initDataUnsafe.user is undefined");
  }
} else {
  alert("Telegram Web App not detected");
}

function handleTouchStart(event) {
  event.preventDefault();
  const hamster = document.getElementById('hamster');
  const rect = hamster.getBoundingClientRect();
  const touch = event.touches[0]; // Берем только первый палец
  if (touch.clientX >= rect.left && touch.clientX <= rect.right && touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
    incrementScore(touch);
    vibrateOnClick();
    hamster.classList.add('active');
    setTimeout(() => hamster.classList.remove('active'), 50);
  }
}

function handleMouseDown(event) {
  event.preventDefault();
  const hamster = document.getElementById('hamster');
  const rect = hamster.getBoundingClientRect();
  if (event.clientX >= rect.left && event.clientX <= rect.right && event.clientY >= rect.top && event.clientY <= rect.bottom) {
    incrementScore(event);
    vibrateOnClick();
    hamster.classList.add('active');
    setTimeout(() => hamster.classList.remove('active'), 50);
  }
}

document.getElementById('hamster').addEventListener('mousedown', handleMouseDown);
document.getElementById('hamster').addEventListener('touchstart', handleTouchStart);

// Загрузка состояния игры при загрузке страницы
window.addEventListener('load', loadGameState);

// Блокировка закрытия окна смахиванием вниз
if (window.Telegram && window.Telegram.WebApp) {
  Telegram.WebApp.MainButton.setParams({
    text: "Закрыть",
    color: "rgb(77, 76, 76)",
    text_color: "#FFFFFF"
  });
  Telegram.WebApp.MainButton.show();
  Telegram.WebApp.MainButton.onClick(function() {
    const url = `https://app.leadteh.ru/w/bQ300?utm_campaign=${balance}`;
    window.Telegram.WebApp.openLink(url);
    window.Telegram.WebApp.close();
  });
}
</script>
</body>
</html>
